name: Render and deploy Quarto site

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  render:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-pandoc@v2

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      # Set-up quarto
      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxml2-dev libssl-dev libcurl4-openssl-dev libgit2-dev

      - name: Install dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          packages: |
            jsonlite
            rvest
            xml2
            httr2
            stringr
            yaml
            
      - name: Dispatch crawl workflow
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          REF: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          WORKFLOW_FILE=crawl.yml
          echo "Dispatching $WORKFLOW_FILE on $REPO ref $REF"
          curl -s -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/actions/workflows/$WORKFLOW_FILE/dispatches" \
            -d "{\"ref\":\"$REF\"}"

          echo "Waiting for workflow run to appear..."
          for i in $(seq 1 30); do
            RUN_ID=$(curl -s -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$REPO/actions/workflows/$WORKFLOW_FILE/runs?branch=$REF&per_page=1" | jq -r '.workflow_runs[0].id') || true
            if [ -n "$RUN_ID" ] && [ "$RUN_ID" != "null" ]; then
              break
            fi
            sleep 2
          done

          if [ -z "$RUN_ID" ] || [ "$RUN_ID" = "null" ]; then
            echo "No workflow run detected; proceeding without waiting."
          else
            echo "Found run $RUN_ID; polling status..."
            while true; do
              RUN_JSON=$(curl -s -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/$REPO/actions/runs/$RUN_ID")
              STATUS=$(echo "$RUN_JSON" | jq -r '.status')
              CONCLUSION=$(echo "$RUN_JSON" | jq -r '.conclusion')
              echo "Status: $STATUS, Conclusion: $CONCLUSION"
              if [ "$STATUS" = "completed" ]; then
                if [ "$CONCLUSION" != "success" ]; then
                  echo "Crawl workflow failed with conclusion $CONCLUSION" >&2
                  exit 1
                fi
                break
              fi
              sleep 5
            done
          fi

      - name: Render site
        run: |
          quarto render

      - name: Commit and push built site (docs/)
        env:
          GIT_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
          GIT_NAME: github-actions[bot]
        run: |
          git config user.name "$GIT_NAME"
          git config user.email "$GIT_EMAIL"
          git add docs || true
          if ! git diff --staged --quiet; then
            git commit -m "chore: render site (CI) [skip ci]" || true
            git push
          else
            echo "No changes to commit"
          fi
